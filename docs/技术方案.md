# LLM 驱动的角色行为技术方案（场景行为手动注册）

## 背景与目标

- 现状：项目中使用 BT（Behaviour Tree）通过固定节点与条件来驱动角色行为，扩展与表达力有限，组合复杂。
- 目标：让 LLM 充当“角色大脑”，在已注册的场景行为集合中进行选择，保证灵活性与叙事性，同时保持可控、可测试、可回退。
- 约束：不复用现有 BT 代码路径，采用手动注册的行为元数据与场景策略；实现语言以 TypeScript 为主。

## 总体架构

- 决策层（LLM）：在“当前场景允许的行为”集合内进行选择，可返回理由与置信信息；不直接执行副作用。
- 执行层（本地）：以确定性函数实现行为的状态变更（位置、活动等），并进行前置条件验证与安全约束。
- 策略层（场景）：以日程为硬约束定义 MORNING/SCHOOL/HOME/EVENING 等场景，对每个场景设定允许行为列表与默认回退行为。
- 记忆层：维护短期记忆（最近决策与原因），可扩展长期记忆（人物设定、关系网）。
- 观测与回退：记录日志与指标；当 LLM 输出无效或不合规时，按场景默认行为回退。

## 关键设计

### 行为注册（ActionRegistry）

- 为每个行为定义元数据：
  - `id`：枚举值，如 `WAKE_UP`、`GO_TO_SCHOOL`、`STUDY_AT_SCHOOL`、`GO_HOME`、`IDLE_AT_HOME`、`SLEEP`
  - `scenes`：适用场景集合（如 `['MORNING','HOME']`）
  - `description`：简述行为用途（供 LLM 理解）
  - `precondition(world,char)`：前置条件（时间窗、位置、当前活动等）
  - `executor(world,char)`：执行器（纯函数更新角色状态）
  - `priority/cooldown`：选择优先级、冷却约束（可选）
- 以集中注册的方式统一维护，便于测试与扩展。

### 场景策略（ScenePolicies）

- 基于日程与状态解析当前场景：
  - 早晨（6–9）：MORNING
  - 上学（9–17）：SCHOOL 或 HOME（视位置而定）
  - 傍晚（17–21）：SCHOOL 或 HOME（视位置而定）
  - 夜间（≥21）：EVENING
- 每个场景设定：
  - `allowed`：允许的行为列表（如 MORNING 允许 `WAKE_UP`、`GO_TO_SCHOOL`、`IDLE_AT_HOME`）
  - `default`：默认回退行为（如 MORNING 默认 `WAKE_UP`）

### 决策循环（tick）

- 流程：
  - 解析场景（基于 `world.hour` 与 `character.location`）
  - 过滤可执行行为（依据 `precondition`）
  - 向 LLM 提供结构化上下文（世界、角色、场景、允许行为摘要、短期记忆）
  - 校验 LLM 输出是否在允许集合内，且预条件满足
  - 执行行为（更新角色状态），并记录短期记忆
  - 若输出无效，重试 2 次，如果还是无效，则使用场景 `default` 行为回退

### LLM 接入（LLMClient）

- 接口：`chooseAction(context) -> { action: ActionId, reason: string }`
- 输出：必须是已注册行为的 `id`，并附带简要理由；拒绝自由文本执行。
- 模型：支持函数/工具调用或严格 JSON 输出；低温度优先以提升确定性。

### 验证与回退

- 验证内容：
  - 输出格式与类型（合法 `ActionId`）
  - 行为是否在当前场景允许集合内
  - `precondition` 是否满足（时间窗、位置、活动）
- 回退策略：
  - 重试二次或降级到固定规则

### 记忆与状态

- 状态最小集：`world.hour`、`character.location`、`character.activity`
- 短期记忆：最近 N 次 `{action, reason, ts}`，帮助 LLM 保持连续性与避免抖动
<!-- - 长期记忆（可选）：人物性格、目标、关系摘要，进入系统提示提高叙事性 -->

### 时间窗与规则

- 以 `PartOfDayWindow` 或常量定义时间窗；前置条件中强制执行（如未到晚间不可 `SLEEP`）。
- 行为间约束示例：
  - `GO_TO_SCHOOL` 需 `location=HOME && activity=WAKE_UP`
  - `STUDY_AT_SCHOOL` 需 `location=SCHOOL && 9≤hour<17`
  - `GO_HOME` 需 `location=SCHOOL && hour≥17`
  - `SLEEP` 需 `location=HOME && hour≥21 && activity!==SLEEPING`

### 安全与约束

- 白名单：LLM 仅可选择 `allowed` 集合内的行为。
- 预条件与冷却：执行前再次验证；避免死循环与频繁切换。
- 命名一致性：统一枚举与字符串命名，避免拼写问题影响稳定映射（例如 `SCHOOL`）。

<!-- ## 测试与可观测性

- 单元测试：
  - `precondition` 与 `executor` 的行为正确性
  - `resolveScene` 与 `getAllowedActions` 的过滤逻辑
- 集成测试：固定输入状态下的稳定选择（低温度）；无效输出时的回退路径。
- 指标与日志：有效动作率、重复率、成本、失败/回退事件时间线。 -->

<!-- ## 风险与对策

- 不稳定选择：低温度、强约束、冷却与重复惩罚。
- 幻觉与越界：结构化输出、白名单校验、默认回退。
- 成本飙升：节流、摘要、缓存、计划化调用。
- 命名不一致：制定枚举与命名规范，添加静态校验。 -->

## 开发与集成计划

- W1：落地注册表与场景策略；实现 `tick` 与验证/回退；接入 LLM SDK（函数/工具调用）。
<!-- - W2：完善短期记忆与日志面板；补充单元与集成测试；优化提示模板。
- W3：引入冷却/重复惩罚与多样性约束；评估成本与性能；视需求加入微计划模式。 -->
